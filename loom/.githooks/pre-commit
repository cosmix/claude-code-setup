#!/bin/sh
# Pre-commit hook: auto-format Rust and markdown files

# Get the repo root (where .git is)
REPO_ROOT="$(git rev-parse --show-toplevel)"

echo "Running pre-commit formatting..."

# Get list of staged files before formatting
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Auto-format Rust code
echo "Formatting Rust code..."
cd "$REPO_ROOT/loom" || exit 1
cargo fmt

# Auto-fix tracked markdown files only
echo "Linting markdown files..."
cd "$REPO_ROOT" || exit 1
MD_FILES=$(git ls-files '*.md')
if [ -n "$MD_FILES" ]; then
    echo "$MD_FILES" | xargs bunx markdownlint-cli2 --fix 2>/dev/null || true
fi

# Re-add any staged files that were modified by formatting
if [ -n "$STAGED_FILES" ]; then
    echo "Re-staging formatted files..."
    echo "$STAGED_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
fi

echo "Pre-commit formatting complete."
